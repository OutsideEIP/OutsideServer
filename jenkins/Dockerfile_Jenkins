FROM jenkins/jenkins@sha256:9405b917836c1d4a073e41a3413808fd5bdb6ac230da84fd4739424830d7c32f

SHELL ["/bin/bash", "-c"]

ARG JENKINS_USER_ADMIN_PASSWORD \
    JENKINS_USER_DEVELOPER_PASSWORD \
    JENKINS_RESOURCES_PATH \
    JENKINS_URL \
    SSH_AGENT_PRIVATE_KEY_FILE \
    SMTP_CREDENTIALS_ID \
    SMTP_USER \
    SMTP_PASSWORD \
    SMTP_PORT \
    SMTP_HOST \
    SMTP_SSL \
    SMTP_TLS \
    EMAIL_EXT_DEFAULT_RECIPIENTS \
    ADMIN_ADDRESS \
    JENKINS_SERVER_REPOSITORY_BRANCH \
    JENKINS_SERVER_REPOSITORY_URL

# Jenkins configuration
COPY ${SSH_AGENT_PRIVATE_KEY_FILE} /etc/.ssh/jenkins-agent-key
USER root
RUN chown jenkins /etc/.ssh/jenkins-agent-key
RUN chmod 600 /etc/.ssh/jenkins-agent-key
USER jenkins

COPY ${JENKINS_RESOURCES_PATH}/plugins.txt /usr/local/plugins.txt
COPY ${JENKINS_RESOURCES_PATH}/configuration.yml /usr/local/configuration.yml
COPY ${JENKINS_RESOURCES_PATH}/jobs.groovy  /usr/local/jobs.groovy
COPY ${JENKINS_RESOURCES_PATH}/Jenkinsfile  /usr/local/Jenkinsfile

RUN /usr/local/bin/install-plugins.sh < /usr/local/plugins.txt

ENV JAVA_OPTS -Djenkins.install.runSetupWizard=false
ENV CASC_JENKINS_CONFIG /usr/local/configuration.yml
ENV JENKINS_USER_ADMIN_PASSWORD $JENKINS_USER_ADMIN_PASSWORD
ENV JENKINS_USER_DEVELOPER_PASSWORD $JENKINS_USER_DEVELOPER_PASSWORD
ENV JENKINS_URL $JENKINS_URL
ENV SSH_AGENT_PRIVATE_KEY_FILE /etc/.ssh/jenkins-agent-key

# Git
ENV JENKINS_SERVER_REPOSITORY_BRANCH $JENKINS_SERVER_REPOSITORY_BRANCH
ENV JENKINS_SERVER_REPOSITORY_URL $JENKINS_SERVER_REPOSITORY_URL

ENV ADMIN_ADDRESS $ADMIN_ADDRESS

# SMTP x EMAIL-EXT
ENV SMTP_CREDENTIALS_ID $SMTP_CREDENTIALS_ID
ENV SMTP_USER $SMTP_USER
ENV SMTP_PASSWORD $SMTP_PASSWORD
ENV SMTP_PORT $SMTP_PORT
ENV SMTP_HOST $SMTP_HOST
ENV SMTP_SSL $SMTP_SSL
ENV SMTP_TLS $SMTP_TLS
ENV EMAIL_EXT_DEFAULT_RECIPIENTS $EMAIL_EXT_DEFAULT_RECIPIENTS

# ----------